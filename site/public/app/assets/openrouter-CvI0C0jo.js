const s={OPENROUTER_API_KEY:"contextforge-openrouter-api-key",OPENROUTER_MODEL:"contextforge-openrouter-model",OLLAMA_URL:"contextforge-ollama-url",OLLAMA_MODEL:"contextforge-ollama-model",COMPRESSION_PROVIDER:"contextforge-compression-provider"},O={OPENROUTER_MODEL:"anthropic/claude-sonnet-4",OLLAMA_URL:"http://localhost:11434",OLLAMA_MODEL:"llama3.2:latest",COMPRESSION_PROVIDER:"claude-code"},f={getApiKey(){return localStorage.getItem(s.OPENROUTER_API_KEY)},setApiKey(t){localStorage.setItem(s.OPENROUTER_API_KEY,t)},clearApiKey(){localStorage.removeItem(s.OPENROUTER_API_KEY)},getModel(){return localStorage.getItem(s.OPENROUTER_MODEL)||O.OPENROUTER_MODEL},setModel(t){localStorage.setItem(s.OPENROUTER_MODEL,t)},isConfigured(){return!!this.getApiKey()}},E={getUrl(){return localStorage.getItem(s.OLLAMA_URL)||O.OLLAMA_URL},setUrl(t){localStorage.setItem(s.OLLAMA_URL,t)},getModel(){return localStorage.getItem(s.OLLAMA_MODEL)||O.OLLAMA_MODEL},setModel(t){localStorage.setItem(s.OLLAMA_MODEL,t)}},k={getProvider(){return localStorage.getItem(s.COMPRESSION_PROVIDER)||O.COMPRESSION_PROVIDER},setProvider(t){localStorage.setItem(s.COMPRESSION_PROVIDER,t)}};async function*S(t,e){const o=E.getUrl(),h=e?.model||E.getModel(),r=await fetch(`${o}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:h,messages:t,stream:!0,options:{temperature:e?.temperature??.7,top_p:e?.topP,num_predict:e?.maxTokens}}),signal:e?.signal});if(!r.ok){const a=await r.text();throw new Error(`Ollama error: ${r.status} ${r.statusText} - ${a}`)}if(!r.body)throw new Error("No response body from Ollama");const R=r.body.getReader(),y=new TextDecoder;let n="",d="",c={};for(;;){const{done:a,value:l}=await R.read();if(a)break;n+=y.decode(l,{stream:!0});const u=n.split(`
`);n=u.pop()||"";for(const i of u)if(i.trim())try{const m=JSON.parse(i);m.message?.content&&(d+=m.message.content,yield m.message.content),m.done&&(c=m)}catch{}}if(n.trim())try{const a=JSON.parse(n);a.message?.content&&(d+=a.message.content,yield a.message.content),a.done&&(c=a)}catch{}return{text:d,promptTokens:c.prompt_eval_count,completionTokens:c.eval_count,totalDuration:c.total_duration}}async function I(){const t=E.getUrl();try{const e=await fetch(`${t}/api/tags`,{method:"GET",signal:AbortSignal.timeout(5e3)});return e.ok?{ok:!0,url:t,model:E.getModel()}:{ok:!1,url:t,error:`HTTP ${e.status}: ${e.statusText}`}}catch(e){let o=e instanceof Error?e.message:"Unknown error";return(o.includes("Failed to fetch")||o.includes("NetworkError"))&&(o=`Cannot connect to Ollama at ${t}. Make sure Ollama is running with CORS enabled: OLLAMA_ORIGINS="*" ollama serve`),{ok:!1,url:t,error:o}}}const T="https://openrouter.ai/api/v1";let p=null,P=null;async function N(t){return p||(P||(P=L()),await P),p?.get(t)??null}async function L(){try{const t=await w();p=new Map;for(const e of t)p.set(e.id,{prompt:parseFloat(e.pricing.prompt)||0,completion:parseFloat(e.pricing.completion)||0})}catch{p=new Map}}function U(t,e,o){return t*o.prompt+e*o.completion}async function*x(t,e){const o=f.getApiKey();if(!o)throw new Error("OpenRouter API key not configured. Please add your API key in Settings.");const h=e?.model||f.getModel(),r=await fetch(`${T}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`,"HTTP-Referer":window.location.origin,"X-Title":"ContextForge"},body:JSON.stringify({model:h,messages:t,stream:!0,temperature:e?.temperature??.7,top_p:e?.topP,max_tokens:e?.maxTokens}),signal:e?.signal});if(!r.ok){const l=await r.text();throw new Error(`OpenRouter error: ${r.status} ${r.statusText} - ${l}`)}if(!r.body)throw new Error("No response body from OpenRouter");const R=r.body.getReader(),y=new TextDecoder;let n="",d="",c,a;for(;;){const{done:l,value:u}=await R.read();if(l)break;n+=y.decode(u,{stream:!0});const i=n.split(`
`);n=i.pop()||"";for(const m of i){const A=m.trim();if(!A||!A.startsWith("data: "))continue;const _=A.slice(6);if(_!=="[DONE]")try{const g=JSON.parse(_);a=g.model;const M=g.choices[0]?.delta?.content;M&&(d+=M,yield M),g.usage&&(c=g.usage)}catch{}}}if(n.trim()&&n.trim().startsWith("data: ")){const l=n.trim().slice(6);if(l!=="[DONE]")try{const u=JSON.parse(l),i=u.choices[0]?.delta?.content;i&&(d+=i,yield i),u.usage&&(c=u.usage)}catch{}}return{text:d,promptTokens:c?.prompt_tokens,completionTokens:c?.completion_tokens,model:a}}async function $(){const t=f.getApiKey();if(!t||t.trim()==="")return{ok:!1,configured:!1};try{const e=await fetch(`${T}/models`,{method:"GET",headers:{Authorization:`Bearer ${t}`},signal:AbortSignal.timeout(5e3)});return e.ok?{ok:!0,configured:!0,model:f.getModel()}:{ok:!1,configured:!0,error:`API error: ${e.status} ${e.statusText}`}}catch(e){return{ok:!1,configured:!0,error:e instanceof Error?e.message:"Unknown error"}}}async function w(){const t=f.getApiKey();if(!t)throw new Error("OpenRouter API key not configured");const e=await fetch(`${T}/models`,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!e.ok)throw new Error(`OpenRouter error: ${e.status} ${e.statusText}`);return(await e.json()).data||[]}export{x as a,I as b,U as c,$ as d,E as e,k as f,N as g,f as o,S as s};
